import{e as h,d as L,n as w,r as z,g as d,R as _,M as B,L as R,C as S}from"./index-405dc887.js";import{d as F}from"./index-827af930.js";import{y as W}from"./index-3bdd7fd6.js";import{c as y}from"./index-4018348e.js";import{C as Y}from"./CollapsiblePanel-ab362bfb.js";import{t as J}from"./index-00e05ac0.js";import{Z as X}from"./ZoomButtons-5cff7a13.js";import{g as K}from"./util-0d2b0d12.js";import{D as Z,S as Q}from"./set-rtl-text-plugin-079893bc.js";import{A as ee}from"./arc-layer-1fd64cf8.js";import{G as C}from"./index-a3e39363.js";import{v as te,f as ie,I as se}from"./icon-manager-1ebc3bb4.js";import{_ as f,ab as ae,a0 as P,L as ne,p as re,a as oe,M as le,G as ce,l as he,ac as ue,ad as de}from"./text-layer-1c567069.js";import{L as me}from"./line-layer-c23cb583.js";import{H as ge}from"./HTTPFileSystem-104f8a6b.js";import{G as x}from"./geojson-layer-ea34a475.js";import"./fxp-26b9b10f.js";import"./extends-98964cd2.js";import"./path-layer-96782934.js";const pe=[255,255,255],fe=1,Se=[0,0,1],ye=[0,0,1];let ve=0;class Te{constructor(e={}){f(this,"id",void 0),f(this,"color",void 0),f(this,"intensity",void 0),f(this,"type","point"),f(this,"position",void 0),f(this,"attenuation",void 0),f(this,"projectedLight",void 0);const{color:t=pe}=e,{intensity:s=fe}=e,{position:r=ye}=e;this.id=e.id||"point-".concat(ve++),this.color=t,this.intensity=s,this.type="point",this.position=r,this.attenuation=be(e),this.projectedLight={...this}}getProjectedLight({layer:e}){const{projectedLight:t}=this,s=e.context.viewport,{coordinateSystem:r,coordinateOrigin:l}=e.props,o=ae(this.position,{viewport:s,coordinateSystem:r,coordinateOrigin:l,fromCoordinateSystem:s.isGeospatial?P.LNGLAT:P.CARTESIAN,fromCoordinateOrigin:[0,0,0]});return t.color=this.color,t.intensity=this.intensity,t.position=o,t}}function be(i){return i.attenuation?i.attenuation:"intensity"in i?[0,0,i.intensity||0]:Se}function Ee(i){const e=i.items.map(t=>h.createElement("li",{key:t.value+t.value[0],style:{display:"flex"}},t.label&&h.createElement("div",{style:{margin:"0 0.5rem 0.0rem 0",fontWeight:"bold"}},t.label),h.createElement("div",{style:{width:"100%",height:"3px",marginTop:"0.5rem",backgroundColor:`rgb(${t.color})`}})));return h.createElement("div",null,h.createElement("h4",{style:{textAlign:"left",fontWeight:"bold",margin:"1rem 0 0.25rem 0",fontSize:"0.8rem"}},i.title),h.createElement("p",null,i.description),h.createElement("ul",{style:{listStyle:"none",padding:0,margin:0}},e))}const Ce=L({name:"PlaybackControls",props:{isRunning:{type:Boolean,required:!0},timeStart:{type:Number,required:!0},timeEnd:{type:Number,required:!0},currentTime:{type:Number,required:!0}},data:()=>({pauseWhileDragging:!1,sliderValue:0,sliderOptions:{min:0,max:1e6,clickable:!1,duration:0,lazy:!0,tooltip:!0,"tooltip-placement":"top"}}),mounted(){this.sliderOptions["custom-formatter"]=i=>this.convertSecondsToClockTimeMinutes(i),window.addEventListener("keyup",this.onKeyPressed)},beforeDestroy(){window.removeEventListener("keyup",this.onKeyPressed)},watch:{currentTime(){this.sliderValue=1e6*(this.currentTime-this.timeStart)/(this.timeEnd-this.timeStart)}},methods:{toggleSimulation(){this.$emit("click")},convertSecondsToClockTimeMinutes(i){const e=this.getSecondsFromSlider(i);try{const t=J(e),s=("00"+t.minutes).slice(-2);return`${t.hours}:${s}`}catch{return"00:00"}},dragStart(){this.isRunning&&(this.pauseWhileDragging=!0,this.$emit("click"))},dragEnd(){this.pauseWhileDragging&&this.$emit("click"),this.pauseWhileDragging=!1},dragging(i){this.$emit("time",this.getSecondsFromSlider(i))},onKeyPressed(i){i.code==="Space"&&this.toggleSimulation()},getSecondsFromSlider(i){let e=(this.timeEnd-this.timeStart)*i/1e6;return e===this.timeEnd&&(e=this.timeEnd-1),e}}});var _e=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"slider-thingy"},[t("div",{staticClass:"buttons"},[t("div",{staticClass:"playpause",on:{click:e.toggleSimulation}},[e.isRunning?t("i",{staticClass:"button-icon fa fa-1x fa-pause"}):t("i",{staticClass:"button-icon fa fa-1x fa-play"})])]),t("b-slider",e._b({staticClass:"slider",attrs:{size:"is-large"},on:{dragging:e.dragging,dragstart:e.dragStart,dragend:e.dragEnd},model:{value:e.sliderValue,callback:function(s){e.sliderValue=s},expression:"sliderValue"}},"b-slider",e.sliderOptions,!1))],1)},Le=[];var we=w(Ce,_e,Le,!1,null,"8621b52a",null,null);const ke=we.exports,Ie={messages:{en:{requests:"DRT&nbsp;Requests",passengers:"Passengers",search:"Search",showhide:"Show/Hide",vehicles:"DRT Vehicles",routes:"Routes",speed:"Speed",backgroundTraffic:"All Traffic"},de:{requests:"DRT&nbsp;Anfragen",passengers:"Passagiere",search:"Suche",showhide:"Ein-/Ausblenden",vehicles:"DRT Fahrzeuge",routes:"Routen",speed:"Geschwindigkeit",backgroundTraffic:"Alle Fahrzeuge"}}},Me=L({name:"XmasSettingsPanel",i18n:Ie,components:{ToggleButton:F.ToggleButton},props:{items:{type:Object,required:!0}}});var De=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"settings-panel-content"},e._l(Object.keys(e.items),function(s){return t("div",{key:s,staticClass:"row"},[t("toggle-button",{staticClass:"toggle",attrs:{width:40,value:e.items[s],labels:!1,color:{checked:"#4b7cc4",unchecked:"#222"}},on:{change:function(r){return e.$emit("click",s)}}}),t("label",{domProps:{innerHTML:e._s(e.$t(s))}})],1)}),0)},Ae=[];var ze=w(Me,De,Ae,!1,null,"f8996b62",null,null);const Re=ze.exports,Pe={currentTime:{type:"number",value:0,min:0},getTimeStart:{type:"accessor",value:null},getTimeEnd:{type:"accessor",value:null},searchFlag:{type:"number",value:0}};class k extends ee{getShaders(){const e=super.getShaders();return e.inject={"vs:#decl":`        attribute float timeStart;
        attribute float timeEnd;
        uniform float currentTime;
        uniform float searchFlag;
        varying float vTime;
      `,"vs:#main-start":`        if (searchFlag == 1.0) {
          vTime = 999.0;
        } else if (timeEnd == -1.0 || timeStart > currentTime || timeEnd < currentTime ) {
          vTime = -1.0;
          return;
        } else {
          float nearBeginning = currentTime - timeStart;
          float nearEnd = timeEnd - currentTime;
          vTime = min(nearBeginning, nearEnd);
        }
      `,"fs:#decl":`        uniform float currentTime;
        uniform float searchFlag;
        varying float vTime;
      `,"fs:#main-start":`      if (searchFlag == 0.0 && vTime == -1.0 ) discard;
      `,"fs:DECKGL_FILTER_COLOR":`        if (vTime <= 10.0) color.a *= (vTime / 10.0);
      `},e}initializeState(e){super.initializeState(e),this.getAttributeManager().addInstanced({timeStart:{size:1,accessor:"getTimeStart"},timeEnd:{size:1,accessor:"getTimeEnd"}})}draw(e){const{currentTime:t}=this.props;e.uniforms=Object.assign({},e.uniforms,{currentTime:t}),super.draw(e)}}k.layerName="DrtRequestArcLayer";k.defaultProps=Pe;const q=[0,0,0,255],xe={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!1,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},iconStill:{type:"object",value:null},getIcon:{type:"accessor",value:i=>i.icon},getColor:{type:"accessor",value:q},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getPathStart:{type:"accessor",value:null},getPathEnd:{type:"accessor",value:null},getTimeStart:{type:"accessor",value:null},getTimeEnd:{type:"accessor",value:null},currentTime:{type:"number",value:0},pickable:{type:"boolean",value:!0},onIconError:{type:"function",value:null,compare:!1,optional:!0}};class I extends ne{getShaders(){return super.getShaders({vs:te,fs:ie,modules:[re,oe]})}initializeState(){this.state={iconManager:new se(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instanceTimestamps:{size:1,accessor:"getTimeStart"},instanceTimestampsNext:{size:1,accessor:"getTimeEnd"},instanceStartPositions:{size:2,accessor:"getPathStart"},instanceEndPositions:{size:2,accessor:"getPathEnd"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:C.UNSIGNED_BYTE,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:C.UNSIGNED_BYTE,normalized:!0,transition:!0,accessor:"getColor",defaultValue:q},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState({oldProps:e,props:t,changeFlags:s}){var p;super.updateState({props:t,oldProps:e,changeFlags:s});const r=this.getAttributeManager(),{iconAtlas:l,iconMapping:o,data:n,getIcon:c}=t,{iconManager:u}=this.state;u.setProps({loadOptions:t.loadOptions});let g=!1;if(l||this.internalState.isAsyncPropLoading("iconAtlas")?(e.iconAtlas!==t.iconAtlas&&u.setProps({iconAtlas:l,autoPacking:!1}),e.iconMapping!==t.iconMapping&&(u.setProps({iconMapping:o}),g=!0)):u.setProps({autoPacking:!0}),(s.dataChanged||s.updateTriggersChanged&&(s.updateTriggersChanged.all||s.updateTriggersChanged.getIcon))&&u.setProps({data:n,getIcon:c}),g&&(r.invalidate("instanceOffsets"),r.invalidate("instanceIconFrames"),r.invalidate("instanceColorModes")),s.extensionsChanged){const{gl:m}=this.context;(p=this.state.model)==null||p.delete(),this.state.model=this._getModel(m),r.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(){super.finalizeState(),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:t,sizeMinPixels:s,sizeMaxPixels:r,sizeUnits:l,billboard:o,alphaCutoff:n,currentTime:c,iconStill:u,pickable:g}=this.props,{iconManager:b}=this.state,{viewport:p}=this.context,m=b.getTexture();m&&this.state.model.setUniforms(e).setUniforms({iconsTexture:m,iconsTextureDim:[m.width,m.height],sizeScale:t*(l==="pixels"?p.metersPerPixel:1),sizeMinPixels:s,sizeMaxPixels:r,billboard:o,alphaCutoff:n,currentTime:c,pickable:g,iconStillOffsets:this.getInstanceOffset(u),iconStillFrames:this.getInstanceIconFrame(u)}).draw()}_getModel(e){const t=[-1,-1,-1,1,1,1,1,-1];return new le(e,{...this.getShaders(),id:this.props.id,geometry:new ce({drawMode:C.TRIANGLE_FAN,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){const{onIconError:t}=this.getCurrentLayer().props;t?t(e):he.error(e.error)()}getInstanceOffset(e){const t=this.state.iconManager.getIconMapping(e);return[t.width/2-t.anchorX||0,t.height/2-t.anchorY||0]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const t=this.state.iconManager.getIconMapping(e);return[t.x||0,t.y||0,t.width||0,t.height||0]}}I.layerName="FlatIconLayer";I.defaultProps=xe;const Fe={currentTime:{type:"number",value:0,min:0},getTimeStart:{type:"accessor",value:null},getTimeEnd:{type:"accessor",value:null},searchFlag:{type:"number",value:0}};class M extends me{getShaders(){const e=super.getShaders();return e.inject={"vs:#decl":`        attribute float timeStart;
        attribute float timeEnd;
        uniform float currentTime;
        uniform float searchFlag;
        varying float vTime;
      `,"vs:#main-start":`        if (searchFlag == 1.0) {
          vTime = 999.0;
        } else if(timeStart > currentTime || timeEnd < currentTime ) {
          vTime = -1.0;
          return;
        } else {
          float nearBeginning = currentTime - timeStart;
          float nearEnd = timeEnd - currentTime;
          vTime = min(nearBeginning, nearEnd);
        }
      `,"fs:#decl":`        uniform float currentTime;
        varying float vTime;
        uniform float searchFlag;
      `,"fs:#main-start":`        if (searchFlag == 0.0 && vTime == -1.0 ) discard;
      `,"fs:DECKGL_FILTER_COLOR":`        if (searchFlag == 0.0 && vTime <= 10.0) color.a *= (vTime / 10.0);
      `},e}initializeState(e){super.initializeState(e),this.getAttributeManager().addInstanced({timeStart:{size:1,accessor:"getTimeStart"},timeEnd:{size:1,accessor:"getTimeEnd"}})}draw(e){const{currentTime:t,searchFlag:s}=this.props;e.uniforms=Object.assign({},e.uniforms,{currentTime:t,searchFlag:s}),super.draw(e)}}M.layerName="PathTraceLayer";M.defaultProps=Fe;const qe="/",Oe={marker:{x:0,y:0,width:128,height:128,mask:!0},info:{x:128,y:0,width:128,height:128,mask:!0},vehicle:{x:128,y:128,width:128,height:128,mask:!0},diamond:{x:0,y:128,width:128,height:128,mask:!1}},$e=new ue({color:[255,255,255],intensity:1}),Ne=new Te({color:[255,255,255],intensity:2,position:[-74.05,40.7,8e3]}),Ve=new de({ambientLight:$e,pointLight:Ne}),Ge={vehicleColor:[200,130,250],trailColor0:[235,235,25],trailColor1:[23,184,190],effects:[Ve]},v={time:0,fromX:1,fromY:2,toX:3,toY:4,veh:5,arrival:6};function je(i){const{simulationTime:e,paths:t,traces:s,drtRequests:r,settingsShowLayers:l,center:o,dark:n,vehicleLookup:c,searchEnabled:u,onClick:g,viewId:b,bgLayers:p}=i,m=Ge,[O,$]=z.useState(o?{center:[16,42],longitude:o[0],latitude:o[1],pitch:0,bearing:0,zoom:10}:Object.assign({},d.state.viewState));_[b]=()=>{$(d.state.viewState)};const N=1,[E,D]=z.useState({});let T=[];p&&(T=[...p]);function V(){console.log(E),E.object?g(E.object.v):g(null)}function G({hoverInfo:a}){const{object:A,x:j,y:H}=a;if(!A)return null;const U=c[A.v];return h.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#ddddeedd",borderLeft:"6px solid green",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#223",padding:"1rem 1rem",position:"absolute",left:j+40,top:H-30}},h.createElement("big",null,h.createElement("b",null,U)),h.createElement("div",null,"tba"))}return l.routes&&T.push(new M({id:"Routen",data:s,currentTime:e,getSourcePosition:a=>a.p0,getTargetPosition:a=>a.p1,getTimeStart:a=>a.t0,getTimeEnd:a=>a.t1,getColor:a=>i.colors[a.occ],getWidth:3,opacity:.7,widthMinPixels:2,rounded:!1,shadowEnabled:!1,searchFlag:u?1:0,pickable:!0,autoHighlight:!0,highlightColor:[255,0,255],onHover:D})),l.vehicles&&T.push(new I({id:"Vehicles",data:t,getPathStart:a=>a.p0,getPathEnd:a=>a.p1,getTimeStart:a=>a.t0,getTimeEnd:a=>a.t1,getIcon:a=>"vehicle",getColor:a=>i.colors[a.occ],iconMoving:"vehicle",iconStill:"diamond",getSize:u?96:84,opacity:1,currentTime:e,shadowEnabled:!1,noAlloc:!0,iconAtlas:`${qe}icon-atlas.png`,iconMapping:Oe,sizeScale:.5,billboard:!1,pickable:!0,depthTest:!0,autoHighlight:!1,highlightColor:[255,0,255],onHover:D,parameters:{depthTest:!1}})),l.requests&&T.push(new k({id:"DRT Requests",data:r,currentTime:e,getSourcePosition:a=>[a[v.fromX],a[v.fromY]],getTargetPosition:a=>[a[v.toX],a[v.toY]],getTimeStart:a=>a[v.time],getTimeEnd:a=>a[v.arrival],getSourceColor:[255,0,255],getTargetColor:[200,255,255],getWidth:N,opacity:.5,searchFlag:u?1:0})),h.createElement(Z,{layers:T,effects:m.effects,pickingRadius:5,viewState:O,controller:!0,getCursor:()=>"pointer",onClick:V,onViewStateChange:a=>{d.commit("setMapCamera",a.viewState)}},h.createElement(Q,{mapStyle:d.getters.mapStyle,mapboxApiAccessToken:B}),G({hoverInfo:E}))}const He={messages:{en:{requests:"DRT Requests",passengers:"Passengers",search:"Search",showhide:"Show/Hide",vehicles:"Vehicles",routes:"Routes",speed:"Speed"},de:{requests:"DRT Anfragen",passengers:"",search:"Suche",showhide:"Ein-/Ausblenden",vehicles:"DRT Fahrzeuge",routes:"DRT Routen",speed:"Geschwindigkeit"}}},Ue=L({name:"VehicleAnimationPlugin",i18n:He,components:{CollapsiblePanel:Y,SettingsPanel:Re,LegendColors:Ee,TripViz:je,PlaybackControls:ke,ToggleButton:F.ToggleButton,ZoomButtons:X},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},configFromDashboard:{type:Object,required:!1},yamlConfig:String,thumbnail:Boolean},data:()=>{const i={1:[85,255,85],2:[255,255,85],3:[240,110,30],"4+":[192,30,50]},e={vehicles:!0,routes:!0};return{viewId:Math.floor(1e12*Math.random()),COLOR_OCCUPANCY:i,SETTINGS:e,legendItems:Object.keys(i).map(t=>({type:R.line,color:i[t],value:t,label:t})),legendRequests:[{type:R.line,color:[255,0,255],value:0,label:""}],vizDetails:{network:"",drtTrips:"",projection:"",title:"",description:"",thumbnail:"",center:[-122,37.3],zoom:10,mapIsIndependent:!1,theme:"",layers:{}},myState:{statusMessage:"",clock:"00:00",colorScheme:S.DarkMode,isRunning:!1,isShowingHelp:!1,subfolder:"",yamlConfig:"",thumbnail:!1,data:[]},bgLayers:[],timeStart:0,timeEnd:100400,traces:y([]),traceStart:{},traceEnd:{},traceVehicle:{},paths:y([]),pathStart:{},pathEnd:{},pathVehicle:{},requests:y([]),requestStart:{},requestEnd:{},requestVehicle:{},simulationTime:9*3600,timeElapsedSinceLastFrame:0,searchTerm:"",searchEnabled:!1,globalState:d.state,isDarkMode:d.state.isDarkMode,isLoaded:!0,showHelp:!1,speedStops:[-20,-10,-5,-2,-1,-.5,-.25,0,.25,.5,1,2,5,10,20],speed:2,legendBits:[],isEmbedded:!1,vehicleLookup:[],vehicleLookupString:{},isPausedDueToHiding:!1}},computed:{fileApi(){return new ge(this.fileSystem,d)},fileSystem(){const i=this.$store.state.svnProjects.filter(e=>e.slug===this.root);if(i.length===0)throw console.log("no such project"),Error;return i[0]},textColor(){const i={text:"#3498db",bg:"#eeeef480"},e={text:"white",bg:"#181518aa"};return this.myState.colorScheme===S.DarkMode?e:i}},watch:{"$store.state.viewState"(){this.vizDetails.mapIsIndependent||_[this.viewId]&&_[this.viewId]()},async"globalState.authAttempts"(){console.log("AUTH CHANGED - Reload"),this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails()},"globalState.colorScheme"(){this.isDarkMode=this.globalState.colorScheme===S.DarkMode,this.updateLegendColors()},searchTerm(){var e,t,s,r,l,o;const i=this.vehicleLookupString[this.searchTerm];i>-1?(console.log("vehicle",i),(e=this.pathVehicle)==null||e.filterExact(i),(t=this.traceVehicle)==null||t.filterExact(i),(s=this.requestVehicle)==null||s.filterExact(i),this.requestStart.filterAll(),this.requestEnd.filterAll(),this.searchEnabled=!0):(console.log("nope"),(r=this.pathVehicle)==null||r.filterAll(),(l=this.traceVehicle)==null||l.filterAll(),(o=this.requestVehicle)==null||o.filterAll(),this.searchEnabled=!1),this.updateDatasetFilters()}},methods:{async handleSettingChange(i){console.log(i),this.SETTINGS[i]=!this.SETTINGS[i],this.updateDatasetFilters(),this.simulationTime+=1},buildRouteFromUrl(){const i=this.$route.params;if(!i.project||!i.pathMatch){console.log("I CANT EVEN: NO PROJECT/PARHMATCH");return}const e=1+i.pathMatch.lastIndexOf("/"),t=i.pathMatch.substring(0,e),s=i.pathMatch.substring(e);this.myState.subfolder=t,this.myState.yamlConfig=s},async getVizDetails(){if(this.configFromDashboard)this.vizDetails=JSON.parse(JSON.stringify(this.configFromDashboard));else try{const e=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig,t=await this.fileApi.getFileText(e);this.vizDetails=W.parse(t)}catch(e){console.log("failed");const t=e;this.fileSystem.needPassword&&t.status===401&&d.commit("requestLogin",this.fileSystem.slug)}this.vizDetails.theme&&this.$store.commit("setTheme",this.vizDetails.theme),this.vizDetails.center&&this.$store.commit("setMapCamera",{longitude:this.vizDetails.center[0],latitude:this.vizDetails.center[1],zoom:this.vizDetails.zoom||10,pitch:20,bearing:0});const i=this.vizDetails.title?this.vizDetails.title:"Agent Animation";this.$emit("title",i)},handleClick(i){if(i===null){this.searchTerm="";return}const e=this.vehicleLookup[i];console.log(e),this.searchTerm===e?this.searchTerm="":this.searchTerm=e},updateLegendColors(){},setWallClock(){const i=Math.floor(this.simulationTime/3600),e=Math.floor(this.simulationTime/60)%60;this.myState.clock=`${i<10?"0":""}${i}${e<10?":0":":"}${e}`},setTime(i){this.simulationTime=i,this.setWallClock(),this.traceStart&&this.pathStart&&this.requestStart&&(this.pathStart.filter([0,this.simulationTime]),this.pathEnd.filter([this.simulationTime,1/0]),this.searchEnabled||(this.traceStart.filter([0,this.simulationTime]),this.traceEnd.filter([this.simulationTime,1/0]),this.requestStart.filter([0,this.simulationTime]),this.requestEnd.filter([this.simulationTime,1/0]))),this.$options.paths=this.paths.allFiltered(),this.$options.traces=this.traces.allFiltered(),this.$options.drtRequests=this.requests.allFiltered()},toggleSimulation(){this.myState.isRunning=!this.myState.isRunning,this.timeElapsedSinceLastFrame=Date.now(),this.myState.isRunning&&this.speed===0&&(this.speed=1),this.myState.isRunning&&this.animate()},async parseDrtRequests(i){if(this.vehicleLookup.length)for(const e of i)try{e[5]=this.vehicleLookupString[e[5]]}catch{}return y(i)},async parseVehicles(i){const e=[];let t=-1;for(const s of i){const r=s.path,l=s.timestamps,o=s.passengers;t++,this.vehicleLookup[t]=s.id,this.vehicleLookupString[s.id]=t;for(let n=0;n<s.path.length-1;n++){const c={t0:l[n],t1:l[n+1],p0:r[n],p1:r[n+1],v:t,occ:o[n]};c.p0[0]==c.p1[0]&&c.p0[1]==c.p1[1]&&(c.occ=0),e.push(c)}}return y(e)},setEmbeddedMode(){"embed"in this.$route.query&&(console.log("EMBEDDED MODE"),this.isEmbedded=!0,this.$store.commit("setShowLeftBar",!1),this.$store.commit("setFullWidth",!0))},updateDatasetFilters(){!this.traceStart||!this.pathStart||!this.requestStart||(this.SETTINGS.routes&&(this.searchEnabled?(this.traceStart.filterAll(),this.traceEnd.filterAll()):(this.traceStart.filter([0,this.simulationTime]),this.traceEnd.filter([this.simulationTime,1/0])),this.$options.traces=this.traces.allFiltered()),this.SETTINGS.vehicles&&(this.pathStart.filter([0,this.simulationTime]),this.pathEnd.filter([this.simulationTime,1/0]),this.$options.paths=this.paths.allFiltered()),this.SETTINGS.requests&&(this.searchEnabled?(this.requestStart.filterAll(),this.requestEnd.filterAll()):(this.requestStart.filter([0,this.simulationTime]),this.requestEnd.filter([this.simulationTime,1/0])),this.$options.drtRequests=this.requests.allFiltered()))},animate(){if(this.myState.isRunning){const i=Date.now()-this.timeElapsedSinceLastFrame;this.timeElapsedSinceLastFrame+=i,this.simulationTime+=i*this.speed*.06,this.updateDatasetFilters(),this.setWallClock(),window.requestAnimationFrame(this.animate)}},handleVisibilityChange(){this.isPausedDueToHiding&&!document.hidden?(console.log("unpausing"),this.isPausedDueToHiding=!1,this.toggleSimulation()):this.myState.isRunning&&document.hidden&&(console.log("pausing"),this.isPausedDueToHiding=!0,this.toggleSimulation())},async parseRouteTraces(i){let e=-1;const t=[];for(const s of i){e++;let r=s.timestamps[0],l=s.timestamps[0],o=[];for(let n=1;n<s.path.length;n++)l=s.timestamps[n],s.path[n][0]===s.path[n-1][0]&&s.path[n][1]===s.path[n-1][1]?(o.forEach(c=>{c.t1=s.timestamps[n-1]}),t.push(...o),o=[],r=l):o.push({t0:r,p0:s.path[n-1],p1:s.path[n],v:e,occ:s.passengers[n-1]});o.forEach(n=>{n.t1=l}),t.push(...o)}return y(t)},async loadBgLayers(){try{if(this.vizDetails.layers.servicearea){const i=await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.layers.servicearea),e=new x({id:"serviceAreaLayer",data:i.features,getFillColor:[10,96,128,255],opacity:.1,pickable:!1,filled:!0});this.bgLayers.push(e)}}catch(i){console.error(i),this.myState.statusMessage=""+i}try{if(this.vizDetails.layers.stops){const i=await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.layers.stops),e=new x({id:"stopsLayer",data:i.features,getFillColor:[255,64,200,255],getPointRadius:30,opacity:1,pickable:!1,filled:!0,pointRadiusUnits:"meters"});this.bgLayers.push(e)}}catch(i){console.error(i),this.myState.statusMessage=""+i}},async loadFiles(){let i=[],e=[];try{if(this.vizDetails.drtTrips.endsWith("json")){const t=await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.drtTrips);i=t.trips,e=t.drtRequests}else if(this.vizDetails.drtTrips.endsWith("gz")){const s=await(await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.drtTrips)).arrayBuffer(),r=K(s),l=new TextDecoder("utf-8").decode(r),o=JSON.parse(l);i=o.trips,e=o.drtRequests}}catch(t){console.error(t),this.myState.statusMessage=""+t}return{trips:i,drtRequests:e}},toggleLoaded(i){this.isLoaded=i},rotateColors(){this.myState.colorScheme=this.myState.colorScheme===S.DarkMode?S.LightMode:S.DarkMode,localStorage.setItem("plugin/agent-animation/colorscheme",this.myState.colorScheme)}},async mounted(){if(d.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=this.yamlConfig??"",this.myState.subfolder=this.subfolder,this.setEmbeddedMode(),await this.getVizDetails(),this.thumbnail)return;this.showHelp=!1,this.updateLegendColors(),this.setWallClock(),this.loadBgLayers(),this.myState.statusMessage="/ Loading data...",console.log("loading files");const{trips:i,drtRequests:e}=await this.loadFiles();console.log("parsing vehicle motion"),this.myState.statusMessage=`${this.$t("vehicles")}...`,this.paths=await this.parseVehicles(i),this.pathStart=this.paths.dimension(t=>t.t0),this.pathEnd=this.paths.dimension(t=>t.t1),this.pathVehicle=this.paths.dimension(t=>t.v),console.log("Routes..."),this.myState.statusMessage=`${this.$t("routes")}...`,this.traces=await this.parseRouteTraces(i),this.traceStart=this.traces.dimension(t=>t.t0),this.traceEnd=this.traces.dimension(t=>t.t1),this.traceVehicle=this.traces.dimension(t=>t.v),console.log("Requests..."),this.myState.statusMessage=`${this.$t("requests")}...`,this.requests=await this.parseDrtRequests(e),this.requestStart=this.requests.dimension(t=>t[0]),this.requestEnd=this.requests.dimension(t=>t[6]),this.requestVehicle=this.requests.dimension(t=>t[5]),console.log("GO!"),this.myState.statusMessage="",document.addEventListener("visibilitychange",this.handleVisibilityChange,!1),this.myState.isRunning=!0,this.timeElapsedSinceLastFrame=Date.now(),this.animate()},beforeDestroy(){document.removeEventListener("visibilityChange",this.handleVisibilityChange),d.commit("setFullScreen",!1),this.$store.commit("setFullScreen",!1),this.myState.isRunning=!1}});var Be=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"gl-app",class:{"hide-thumbnail":!e.thumbnail},attrs:{oncontextmenu:"return false"}},[e.thumbnail?e._e():t("trip-viz",{staticClass:"anim",attrs:{center:e.vizDetails.center,colors:e.COLOR_OCCUPANCY,drtRequests:e.$options.drtRequests,dark:e.globalState.isDarkMode,paths:e.$options.paths,settingsShowLayers:e.SETTINGS,searchEnabled:e.searchEnabled,simulationTime:e.simulationTime,traces:e.$options.traces,vehicleLookup:e.vehicleLookup,viewId:e.viewId,onClick:e.handleClick,bgLayers:e.bgLayers}}),e.thumbnail?e._e():t("zoom-buttons"),e.isLoaded&&!e.thumbnail?t("div",{staticClass:"right-side"},[t("collapsible-panel",{attrs:{direction:"right"}},[t("div",{staticClass:"big clock"},[t("p",[e._v(e._s(e.myState.clock))])]),t("div",{staticClass:"panel-items"},[e.legendItems.length?t("legend-colors",{staticClass:"legend-block",attrs:{title:"Occupancy",items:e.legendItems}}):e._e()],1),t("div",{staticClass:"panel-items"},[t("settings-panel",{staticClass:"settings-area",attrs:{items:e.SETTINGS},on:{click:e.handleSettingChange}}),t("div",{staticClass:"speed-block"},[t("p",{staticClass:"speed-label"},[e._v(e._s(e.$t("speed"))),t("br"),e._v(e._s(e.speed)+"x")]),t("b-slider",{staticClass:"speed-slider",attrs:{min:e.speedStops[0],max:e.speedStops[e.speedStops.length-1],duration:0,dotSize:20,tooltip:!0,"tooltip-placement":"none"},model:{value:e.speed,callback:function(s){e.speed=s},expression:"speed"}},[e._l(e.speedStops,function(s){return[t("b-slider-tick",{key:s,attrs:{value:s}})]})],2)],1)],1)])],1):e._e(),!e.thumbnail&&e.isLoaded?t("playback-controls",{staticClass:"bottom-area",attrs:{timeStart:e.timeStart,timeEnd:e.timeEnd,isRunning:e.myState.isRunning,currentTime:e.simulationTime},on:{click:e.toggleSimulation,time:e.setTime}}):e._e()],1)},We=[];var Ye=w(Ue,Be,We,!1,null,"0591ab0a",null,null);const gt=Ye.exports;export{gt as default};
//# sourceMappingURL=VehicleAnimation-85c420fc.js.map
